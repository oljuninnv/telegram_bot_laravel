# Telegram-бот для сбора отчетов и интеграции с Google Таблицами

## Краткое описание
Этот проект представляет собой Telegram-бота, разработанного для автоматизации сбора информации о присланных отчётах в чатах. Для идентификации отчёта используятся хэштеги. Бот проверяет наличие сообщений с хештегами за указанный период и отправляет данные о пропущенных отчётах в Google Таблицу, а также уведомляет пользователя в личных сообщениях.

Проект реализован на связке технологий **Laravel** и **Telegram Bot SDK**, что обеспечивает гибкость и масштабируемость решения.

## Основной функционал

- **Сбор информации о сообщениях с хештегами** в Telegram-чатах за определённый период.
- **Фильтрация сообщений** по хештегам.
- **Формирование отчётов**:
  - Создание списка чатов, где отсутствовали сообщения с указанными хештегами.
- **Интеграция с Google Таблицами**:
  - Автоматическое создание листов с отчётами.
  - Запись данных в таблицу с указанием периода и списка чатов.
- **Уведомления в Telegram**:
  - Отправка отчётов в личные сообщения настраиваемому пользователю.
  - Каждый отчёт отправляется отдельным сообщением.
- **Настройка бота**:
  - Настройка периода сбора отчёта.
  - Настройка хэштегов.
  - Настройка пользователей бота.
- **Автоматическое удаление заблокированных пользователей, после 2-ух недели от даты блокировки**:

## Технические требования

Для запуска проекта на персональном компьютере необходимо установить следующие компоненты:

- **PHP** (версия 8.0 или выше).
- **Composer** (менеджер зависимостей для PHP).
- **Git** (для управления версиями).
- **MySQL** (база данных для хранения информации).
- **ngrok** (для публичного доступа к локальному серверу).
- **Postman** (для подключения webhook'а к боту).

## Установка и настройка

### 1. Начальная настройка проекта:

1. Клонируйте проект через команду:
  ```
  git clone https://github.com/oljuninnv/telegram_bot_laravel.git
  ```
2. Установите зависимости проекта с помощью Composer:
  ```
  composer install
  ```
если не работает, то попробовать
  ```
  composer install --ignore-platform-req=ext-sodium
  ```
3. Скопируйте файл .env.example в .env:
  ```
  cp .env.example .env
  ```
4. Откройте файл .env и настройте параметры подключения к базе данных:
  ```
  DB_CONNECTION=mysql
  DB_HOST=127.0.0.1
  DB_PORT=3306
  DB_DATABASE=<your_database_name>
  DB_USERNAME=<your_database_user>
  DB_PASSWORD=<your_database_password>
  ```
5. Сгенерируйте ключ приложения командой: 
  ```
  php artisan key:generate;
  ```
6. Выполните миграцию для создания таблиц в вашей базе данных:
  ```
  php artisan migrate
  ```
7. Запустите seeder командой, который заполнит ваши таблици настройками и хэштегами по умолчанию:
  ```
  php artisan db:seed
  ```

### 2. Создание Telegram-бота:

1. Перейдите в Telegram и запустите бота [@BotFather](https://t.me/BotFather).
2. Используйте команду `/newbot` для создания нового бота.
3. Укажите имя бота и получите токен доступа.
4. Сохраните токен для дальнейшей настройки.
5. Для того, чтобы дать возможность боту читать сообщения в чатах необходимо перейти по данному пути **/mybots** → **Имя вашего бота** → **Bot Settings** → **Group Privacy** и нажать на кнопку **Turn off** 

### 3. Настройка Google Cloud Console:

1. Перейдите на [Google Cloud Console](https://console.cloud.google.com/).
2. Создайте новый проект.
3. Активируйте API Google Sheets.
4. Создайте **Service Account**:
   - Перейдите в раздел **Credentials**.
   - Нажмите **Create Credentials** → **Service Account**.
   - Укажите имя, создайте аккаунт и добавьте новый ключ в формате JSON.
   - Скачайте файл ключа и переименуйте его в `credentials.json`.
   - Созданныый ключ перенесите в каталог /storage.
5. Создайте **OAuth 2.0 Client IDs** для аутентификации.
6. Создайте **Api Keys** для аутентификации приложений при доступе к API-сервисам.

### 4. Настройка ngrok:

1. Зарегистрируйтесь, используя VPN, на сайте [ngrok](https://ngrok.com/) и создайте бесплатный аккаунт.
2. Скачайте ngrok на свой компьютер.
2. Запустите ngrok с включённым VPN для перенаправления локального сервера командой:
```
ngrok http 8000
```
3. Через postman, выберите метод POST и вставьте строку: 

```
https://api.telegram.org/bot{token_вашего_бота}/setWebhook?url={ссылка_предоставляемая_ngrok_Forwarding}/telegram-webhook
```

### 5. Настройка Google таблицы:

1. Создайте таблицу Google Sheets;
2. Добавьте в качестве редактора email сервисного аккаунта.

### 6. Подключение WebHook, Google таблиц и бота:

Для подключения всех необходимых компонентов, необходимо перейти в **.env** и установить свои данные
```
- TELEGRAM_BOT_TOKEN="токен вашего бота (получаемый от botfather)"
- TELEGRAM_WEBHOOK_URL="({ссылка_предоставляемая_ngrok(Forwarding)}/telegram-webhook)"
- TELEGRAM_USER_ADMIN_ID="ваш id в телеграмм"
- GOOGLE_APPLICATION_NAME="название вашей таблицы"
- GOOGLE_SHEET_ID="ID вашей страницы (получается из ссылки Пример: https://docs.google.com/spreadsheets/d/12345/editgid=232067112#gid=232067112 , где 12345 - GOOGLE_SHEET_ID)"
- GOOGLE_SERVICE_ACCOUNT_JSON_LOCATION=storage/credentials.json
- GOOGLE_CLIENT_ID="CLIENT_ID, получаемый при создании OAuth 2.0 Client ID"
- GOOGLE_CLIENT_SECRET="CLIENT_SECRET, получаемый при создании OAuth 2.0 Client ID"
- GOOGLE_SERVICE_ENABLED=true
```

### 7. Запустите бота:
1. Запустите локальный сервер
```
php artisan serve
```
2. Перейдите по ссылке ngrok под пунктом Web Interface, дополните её /inspect/http для обслуживания ответов бота

3. Запустите бота командой **/start**

### 8. Добавление задачи в планировщик:

1. Используйте Windows Task Scheduler или Cron(Linux);
2. Добавьте задачу с запуском PHP и аргументом reports:send;
3. Установите триггер на ежедневное выполнение с интервалом в минуту.

## Краткое описание работы с ботом

### 1. Управление чатами в базе данных:

В проекте реализована функциональность для автоматического добавления и удаления чатов из базы данных. Это позволяет боту отслеживать активные чаты и управлять данными о них.

#### 1. Добавление чата в базу данных
  ##### Условие добавления:
  - Бот должен быть добавлен в чат.
  - Пользователь, добавивший бота, должен быть администратором и не заблокирован, иначе бот автоматически выйдет из чата.
  ##### Процесс добавления:
  - При добавлении бота в чат, система проверяет, существует ли чат в базе данных.
  - Если чат отсутствует, он добавляется в таблицу chats.
  - После успешного добавления, бот отправляет сообщение с инструкцией по использованию хэштегов для отправки отчётов.
  
  Примечание: перед добавлением бота в чат, можно сделать чат публичным и создать ссылку на чат. В таком случае бот будет записывать ссылку на чат при его добавлении.
#### 2. Удаление чата из базы данных
  ##### Условие удаления:
  - Бот должен быть удалён из чата или исключён из него.
  ##### Процесс удаления:
  - При удалении бота из чата, система проверяет статус пользователя.
  - Если статус указывает на то, что бот был удалён или исключён, все данные, связанные с этим чатом, удаляются из базы данных.
  - После успешного удаления, бот отправляет сообщение администраторам об удалении его из чата.

### 2. Управление настройками:

В данном разделе описаны основные возможности управления настройками Telegram-бота, включая настройку сбора отчётов, управление хэштегами и пользователями.

#### 1. Настройка периода сбора отчётов
  ##### Выбор дня недели:
  - Бот позволяет выбрать день недели, в который будет происходить сбор отчётов.
  - Доступны все дни недели, а также возможность оставить текущий день без изменений.
  ##### Настройка периода сбора:
  - Пользователь может указать, через сколько недель будет происходить сбор отчётов (от 1 до 10 недель).
  - Есть возможность оставить текущий период без изменений.
  ##### Настройка периода сбора:
  - Время сбора отчётов задаётся в формате HH:MM.
  - Можно оставить текущее время без изменений.

#### 2. Управление хэштегами
  ##### Создание хэштега:
  - Хэштег создаётся в формате #example, Заголовок отчёта.
  - Хэштег должен начинаться с символа #.
  ##### Удаление хэштега:
  - Пользователь может удалить существующий хэштег из базы данных.
  - Перед удалением требуется подтверждение.
  ##### Привязка хэштега к  настройкам:
  - Хэштеги можно привязывать к настройкам сбора отчётов.
  - Также есть возможность отвязать хэштег от настроек.

#### 3. Управление пользователями
  ##### Добавление нового пользователя:
  - Администратор может создать нового пользователя путём ввода его username и выбора его роли (например, user - не имеет никакого доступа к функционалу бота,admin - имеет право получать данные из чатов,super-admin - имеет право получать данные из чатов и управлять настройками).
  - Перед добавлением пользователя требуется подтверждение.
  ##### Редактирование ролей пользователей:
  - Администратор может изменять роли пользователей (например, назначить пользователя user - не имеет никакого доступа к функционалу бота,admin - имеет право получать данные из чатов,super-admin - имеет право получать данные из чатов и управлять настройками).
  - Перед изменением роли требуется подтверждение.
  ##### Блокировка пользователей
  - Администратор может заблокировать или разблокировать пользователей.
  - Перед блокировкой требуется подтверждение.

## Заключение
Теперь вы готовы к использованию бота и всего его функционала. Спасибо за внимание!